name: Deploy Oracle VPS
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Executando Deploy AutomÃ¡tico via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USER }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          script: |
            echo "Iniciando Pipeline de Deploy..."

            # Se a pasta nÃ£o existir no servidor, ele faz o clone
            if [ ! -d "/home/${{ secrets.ORACLE_USER }}/wesley-bot-whatsapp-assistant" ]; then
              git clone https://github.com/${{ github.repository }}.git /home/${{ secrets.ORACLE_USER }}/wesley-bot-whatsapp-assistant
            fi

            # Entra na pasta do repo
            cd /home/${{ secrets.ORACLE_USER }}/wesley-bot-whatsapp-assistant

            # ForÃ§a o pull das atualizaÃ§Ãµes mais recentes e descarta mudanÃ§as locais conflitantes
            git fetch --all
            git reset --hard origin/main
            git pull origin main

            # Recria as variÃ¡veis de ambiente pra IA e Evolution
            echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" > .env
            echo "EVOLUTION_API_KEY=${{ secrets.EVOLUTION_API_KEY }}" >> .env

            # Recarrega MÃ¡quinas
            docker compose down
            docker compose up -d --build

            echo "Pipeline ConcluÃ­do com Sucesso! ðŸš€"
