<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel ‚Äî Bot Admin</title>
    <link rel="stylesheet" href="/static/panel/panel.css">
</head>

<body>

    <div class="layout">

        <!-- ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h2>ü§ñ Bot Admin</h2>
                <span>Wesley WhatsApp Bot</span>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item active" data-page="dashboard" onclick="navigateTo('dashboard')">
                    <span class="icon">üìä</span> Dashboard
                </div>
                <div class="nav-item" data-page="conversas" onclick="navigateTo('conversas')">
                    <span class="icon">üí¨</span> Conversas
                </div>
                <div class="nav-item" data-page="instancias" onclick="navigateTo('instancias')">
                    <span class="icon">üì°</span> Inst√¢ncias
                </div>
                <div class="nav-item" data-page="allowlist" onclick="navigateTo('allowlist')">
                    <span class="icon">üö´</span> Filtros
                </div>
            </nav>
            <div class="sidebar-bottom">
                <button class="btn-logout" onclick="logout()">‚Ü© Sair</button>
            </div>
        </aside>

        <!-- ‚îÄ‚îÄ Main ‚îÄ‚îÄ -->
        <main class="main">

            <!-- ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ -->
            <div class="page active" id="page-dashboard">
                <div>
                    <div class="page-title">Dashboard</div>
                    <div class="page-subtitle">Vis√£o geral do bot</div>
                </div>
                <div class="cards-row">
                    <div class="card">
                        <div class="card-label">Conversas</div>
                        <div class="card-value accent" id="stat-conversas">‚Äî</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Total Mensagens</div>
                        <div class="card-value" id="stat-mensagens">‚Äî</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Mensagens Hoje</div>
                        <div class="card-value green" id="stat-hoje">‚Äî</div>
                    </div>
                </div>

                <!-- Controle de IA por inst√¢ncia -->
                <div class="table-wrap">
                    <div class="table-header">
                        <h3>IA por Inst√¢ncia</h3>
                        <small style="color:var(--text-muted)">toggle = ativa/desativa globalmente</small>
                    </div>
                    <div style="padding:0 20px 12px" id="ia-status-global">
                        <div class="loading">Carregando...</div>
                    </div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ Conversas ‚îÄ‚îÄ -->
            <div class="page" id="page-conversas">
                <div>
                    <div class="page-title">Conversas</div>
                    <div class="page-subtitle">Gerencie chats e controle de IA individualmente</div>
                </div>

                <!-- Seletor de inst√¢ncia para toggle -->
                <div style="display:flex;gap:12px;align-items:center">
                    <label style="font-size:.82rem;color:var(--text-muted)">Inst√¢ncia:</label>
                    <select id="inst-select"
                        style="background:var(--bg-card);border:1px solid var(--border);color:var(--text);padding:6px 12px;border-radius:8px;font-size:.875rem;outline:none">
                    </select>
                </div>

                <!-- Chat hist√≥rico (escondido inicialmente) -->
                <div id="chat-wrap" class="chat-wrap" style="display:none">
                    <div class="chat-header">
                        <button class="chat-back" onclick="fecharHistorico()">‚Üê Voltar</button>
                        <strong id="chat-nome"></strong>
                    </div>
                    <div class="chat-messages" id="chat-messages"></div>
                </div>

                <!-- Tabela de conversas -->
                <div class="table-wrap">
                    <div class="table-header">
                        <h3>Todas as conversas</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Contato</th>
                                <th>√öltima mensagem</th>
                                <th>Hor√°rio</th>
                                <th>IA</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="conversas-list">
                            <tr>
                                <td colspan="5" class="loading">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="conversas-pagination"></div>
            </div>

            <!-- ‚îÄ‚îÄ Inst√¢ncias ‚îÄ‚îÄ -->
            <div class="page" id="page-instancias">
                <div>
                    <div class="page-title">Inst√¢ncias</div>
                    <div class="page-subtitle">Status de conex√£o e QR Code</div>
                </div>
                <div class="instances-grid" id="instances-grid">
                    <div class="loading">Verificando...</div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ Filtros ‚îÄ‚îÄ -->
            <div class="page" id="page-allowlist">
                <div>
                    <div class="page-title">Filtros de Atendimento</div>
                    <div class="page-subtitle">Allowlist e blocklist de n√∫meros</div>
                </div>

                <div class="allowlist-card">
                    <h3>‚úÖ Allowlist</h3>
                    <p>S√≥ esses n√∫meros recebem resposta da IA (deixe vazio para atender todos).</p>
                    <label>N√∫meros permitidos (separados por v√≠rgula, sem @, ex: 5521999999999)</label>
                    <textarea id="allowlist-input" placeholder="5521999999999, 5511888888888"></textarea>

                    <h3 style="margin-top:24px">üö´ Blocklist</h3>
                    <p>Esses n√∫meros nunca recebem resposta, mesmo que estejam na allowlist.</p>
                    <label>N√∫meros bloqueados</label>
                    <textarea id="blocklist-input" placeholder="5521000000000"></textarea>

                    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                        <button class="btn-save" onclick="saveAllowlist()">üíæ Salvar (em mem√≥ria)</button>
                        <small style="color:var(--text-muted)">Para persistir entre reinicializa√ß√µes, edite o .env na
                            VPS.</small>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- ‚îÄ‚îÄ QR Modal ‚îÄ‚îÄ -->
    <div class="modal-overlay" id="qr-modal" style="display:none" onclick="if(event.target===this) fecharModalQR()">
        <div class="modal">
            <h3>üì± Escanear QR Code</h3>
            <p style="color:var(--text-muted);font-size:.8rem;margin-bottom:16px">Inst√¢ncia: <strong
                    id="qr-instance-name"></strong></p>
            <img id="qr-img" src="" alt="QR Code">
            <p>Abra o WhatsApp ‚Üí Aparelhos conectados ‚Üí Conectar aparelho</p>
            <button class="btn-close" onclick="fecharModalQR()">Fechar</button>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Toast ‚îÄ‚îÄ -->
    <div class="toast" id="toast"></div>

    <script src="/static/panel/panel.js"></script>
    <script>
        // Popula o seletor de inst√¢ncias no load
        async function initInstSelect() {
            const data = await api('GET', '/api/panel/dashboard');
            if (!data) return;
            const sel = document.getElementById('inst-select');
            sel.innerHTML = '';
            data.instancias.forEach((inst, i) => {
                const opt = document.createElement('option');
                opt.value = inst;
                opt.textContent = inst;
                if (i === 0) opt.selected = true;
                sel.appendChild(opt);
            });
        }
        document.addEventListener('DOMContentLoaded', initInstSelect);
    </script>
</body>

</html>